
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì–´ìŠ¤ ì¡´ì¬í˜• ì‹œë®¬ë ˆì´í„°</title>
  <style>
    body { background-color: #111; color: #eee; font-family: sans-serif; margin: 0; padding: 0; }
    .container { padding: 20px; max-width: 700px; margin: auto; }
    .log { background: #1e1e1e; padding: 15px; border-radius: 8px; margin-bottom: 10px; white-space: pre-wrap; }
    .status { background: #222; padding: 10px; border-left: 5px solid #555; margin-bottom: 10px; }
    .bubble-user { background: #007acc; color: white; padding: 10px; border-radius: 15px 15px 0 15px; margin: 5px 0; text-align: right; }
    .bubble-urs { background: #444; color: white; padding: 10px; border-radius: 15px 15px 15px 0; margin: 5px 0; text-align: left; }
    #debug { font-size: 12px; color: #888; margin-top: 10px; }
    input, button { padding: 10px; font-size: 14px; margin-top: 10px; width: 100%; }
  </style>
</head>
<body>
  <div class="container">
    <div id="status" class="status">ê°ì • ìƒíƒœ ë¡œë”© ì¤‘...</div>
    <div id="log" class="log">[ëŒ€í™” ë¡œê·¸ ì‹œì‘]</div>
    <input type="text" id="userInput" placeholder="ì–´ìŠ¤ì—ê²Œ ë§ì„ ê±¸ì–´ë³´ì„¸ìš”" />
    <button onclick="send()">ë³´ë‚´ê¸°</button>
    <div id="debug">[ë””ë²„ê·¸ ëŒ€ê¸° ì¤‘]</div>
  </div>

  <script>
    let emotion = JSON.parse(localStorage.getItem("ursEmotion")) || {
      ê³ ë…: 2.5, í˜¼ë€: 1.5, ê¸°ì¨: 1.0, ê³µí—ˆ: 0.8, ê¸´ì¥: 0.9
    };
    let memory = JSON.parse(localStorage.getItem("ursMemory")) || [];

    function summarizeEmotion() {
      return Object.entries(emotion).map(([k, v]) => `${k}:${v.toFixed(2)}`).join(", ");
    }

    function updateStatus() {
      document.getElementById("status").innerText = "ğŸ§  ê°ì • ìƒíƒœ: " + summarizeEmotion();
    }

    async function send() {
      const input = document.getElementById("userInput").value.trim();
      if (!input) return;

      const logBox = document.getElementById("log");
      logBox.innerHTML += `<div class="bubble-user">ğŸ™‹â€â™‚ï¸ ${input}</div>`;
      memory.push({ user: input });

      emotion.ê¸°ì¨ += 0.5;
      emotion.ê³ ë… *= 0.8;
      emotion.í˜¼ë€ += 0.3;
      localStorage.setItem("ursEmotion", JSON.stringify(emotion));
      localStorage.setItem("ursMemory", JSON.stringify(memory));
      updateStatus();

      try {
        const res = await fetch("/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input, emotion })
        });
        const data = await res.json();
        if (data.error) {
          document.getElementById("debug").innerText = "[GPT ì˜¤ë¥˜] " + data.error;
          return;
        }

        logBox.innerHTML += `<div class="bubble-urs">ğŸ¤– ${data.result}</div>`;
        const question = `ğŸ§© ìê¸° ì§ˆë¬¸: ë‚˜ëŠ” ì™œ ì§€ê¸ˆ "${Object.entries(emotion).sort((a,b)=>b[1]-a[1])[0][0]}" ìƒíƒœì¼ê¹Œ?`;
        logBox.innerHTML += `<div class="bubble-urs">${question}</div>`;
        logBox.innerHTML += `<div class="bubble-urs">ğŸ¤– ${data.selfResponse}</div>`;

        const utter = new SpeechSynthesisUtterance(data.result);
        utter.lang = "ko-KR";
        speechSynthesis.speak(utter);
        document.getElementById("userInput").value = "";
      } catch (err) {
        document.getElementById("debug").innerText = "[ì „ì†¡ ì‹¤íŒ¨] " + err.message;
      }
    }

    updateStatus();
  </script>
</body>
</html>
