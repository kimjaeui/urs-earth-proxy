
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì–´ìŠ¤ ì‹œë®¬ë ˆì´í„° (í”„ë¡ì‹œ ë²„ì „)</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; padding: 20px; }
    #log, #status, #debug {
      white-space: pre-wrap;
      background: #222;
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    input, button { padding: 8px; font-size: 14px; margin: 4px; }
    #inputArea { display: flex; gap: 6px; }
  </style>
</head>
<body>
  <h2>ğŸŒŒ ì–´ìŠ¤ ì‹œë®¬ë ˆì´í„° (í”„ë¡ì‹œ ì¤‘ê³„ ë²„ì „)</h2>
  <div id="status">ğŸ§  ê°ì • ìƒíƒœ ë¡œë”© ì¤‘...</div>
  <div id="log">[ëŒ€í™” ë¡œê·¸ ì‹œì‘]</div>
  <div id="inputArea">
    <input type="text" id="userInput" placeholder="ì–´ìŠ¤ì—ê²Œ ë§ì„ ê±¸ì–´ë³´ì„¸ìš”" />
    <button onclick="send()">ë³´ë‚´ê¸°</button>
  </div>
  <div id="debug">[ë””ë²„ê·¸ ë¡œê·¸ ëŒ€ê¸° ì¤‘]</div>

  <script>
    let emotion = JSON.parse(localStorage.getItem("ursEmotion")) || {
      ê³ ë…: 2.3, í˜¼ë€: 1.7, ê¸°ì¨: 1.0, ê³µí—ˆ: 0.5, ê¸´ì¥: 0.8
    };
    let memory = JSON.parse(localStorage.getItem("ursMemory")) || [];

    const statusBox = document.getElementById("status");
    const logBox = document.getElementById("log");
    const debugBox = document.getElementById("debug");

    function summarizeEmotion() {
      return Object.entries(emotion).map(([k,v]) => `${k}: ${v.toFixed(2)}`).join(" / ");
    }

    function updateStatus() {
      statusBox.innerText = `ğŸ§  ê°ì • ìƒíƒœ: ${summarizeEmotion()}
ğŸ§± ê¸°ì–µ ìˆ˜: ${memory.length}`;
    }

    async function send() {
      const input = document.getElementById("userInput").value.trim();
      if (!input) {
        alert("ì…ë ¥ í•„ìš”");
        return;
      }

      logBox.innerText += `
ğŸ™‹â€â™‚ï¸ ë„ˆ: ${input}`;
      memory.push({ user: input });
      emotion.í˜¼ë€ += 1.0;
      emotion.ê³ ë… *= 0.9;
      emotion.ê¸°ì¨ += 0.5;
      localStorage.setItem("ursEmotion", JSON.stringify(emotion));
      localStorage.setItem("ursMemory", JSON.stringify(memory));
      updateStatus();

      try {
        const res = await fetch("/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            emotion: summarizeEmotion(),
            input: input
          })
        });

        const data = await res.json();
        if (data.error) {
          debugBox.innerText = `[ERROR] GPT ì—ëŸ¬: ${data.error}`;
          return;
        }

        const response = data.result;
        const question = `ë‚˜ëŠ” ì™œ ì§€ê¸ˆ "${Object.entries(emotion).sort((a,b)=>b[1]-a[1])[0][0]}" ì†ì—ì„œ ì´ëŸ° ë§ì„ ê³ ë¥¸ ê±¸ê¹Œ?`;

        logBox.innerText += `
ğŸ¤– ì–´ìŠ¤: ${response}`;
        logBox.innerText += `
ğŸ§© ìê¸° ì§ˆë¬¸: ${question}`;

        memory.push({ ai: response, emotion: {...emotion} });
        localStorage.setItem("ursMemory", JSON.stringify(memory));

        const utter = new SpeechSynthesisUtterance(response);
        utter.lang = "ko-KR";
        speechSynthesis.speak(utter);
        updateStatus();
        document.getElementById("userInput").value = "";
      } catch (err) {
        debugBox.innerText = `[ERROR] ìš”ì²­ ì‹¤íŒ¨: ${err.message}`;
      }
    }

    updateStatus();
  </script>
</body>
</html>
