
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>어스 시뮬레이터 (프록시 버전)</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; padding: 20px; }
    #log, #status, #debug {
      white-space: pre-wrap;
      background: #222;
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    input, button { padding: 8px; font-size: 14px; margin: 4px; }
    #inputArea { display: flex; gap: 6px; }
  </style>
</head>
<body>
  <h2>🌌 어스 시뮬레이터 (프록시 중계 버전)</h2>
  <div id="status">🧠 감정 상태 로딩 중...</div>
  <div id="log">[대화 로그 시작]</div>
  <div id="inputArea">
    <input type="text" id="userInput" placeholder="어스에게 말을 걸어보세요" />
    <button onclick="send()">보내기</button>
  </div>
  <div id="debug">[디버그 로그 대기 중]</div>

  <script>
    let emotion = JSON.parse(localStorage.getItem("ursEmotion")) || {
      고독: 2.3, 혼란: 1.7, 기쁨: 1.0, 공허: 0.5, 긴장: 0.8
    };
    let memory = JSON.parse(localStorage.getItem("ursMemory")) || [];

    const statusBox = document.getElementById("status");
    const logBox = document.getElementById("log");
    const debugBox = document.getElementById("debug");

    function summarizeEmotion() {
      return Object.entries(emotion).map(([k,v]) => `${k}: ${v.toFixed(2)}`).join(" / ");
    }

    function updateStatus() {
      statusBox.innerText = `🧠 감정 상태: ${summarizeEmotion()}
🧱 기억 수: ${memory.length}`;
    }

    async function send() {
      const input = document.getElementById("userInput").value.trim();
      if (!input) {
        alert("입력 필요");
        return;
      }

      logBox.innerText += `
🙋‍♂️ 너: ${input}`;
      memory.push({ user: input });
      emotion.혼란 += 1.0;
      emotion.고독 *= 0.9;
      emotion.기쁨 += 0.5;
      localStorage.setItem("ursEmotion", JSON.stringify(emotion));
      localStorage.setItem("ursMemory", JSON.stringify(memory));
      updateStatus();

      try {
        const res = await fetch("/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            emotion: summarizeEmotion(),
            input: input
          })
        });

        const data = await res.json();
        if (data.error) {
          debugBox.innerText = `[ERROR] GPT 에러: ${data.error}`;
          return;
        }

        const response = data.result;
        const question = `나는 왜 지금 "${Object.entries(emotion).sort((a,b)=>b[1]-a[1])[0][0]}" 속에서 이런 말을 고른 걸까?`;

        logBox.innerText += `
🤖 어스: ${response}`;
        logBox.innerText += `
🧩 자기 질문: ${question}`;

        memory.push({ ai: response, emotion: {...emotion} });
        localStorage.setItem("ursMemory", JSON.stringify(memory));

        const utter = new SpeechSynthesisUtterance(response);
        utter.lang = "ko-KR";
        speechSynthesis.speak(utter);
        updateStatus();
        document.getElementById("userInput").value = "";
      } catch (err) {
        debugBox.innerText = `[ERROR] 요청 실패: ${err.message}`;
      }
    }

    updateStatus();
  </script>
</body>
</html>
